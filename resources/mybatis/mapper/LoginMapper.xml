<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.house.team.user.dao.LoginMapper">

	<select id="selectByProviderAndEmail" resultType="com.house.team.user.vo.LoginVO">
        SELECT * FROM SOCIAL_LOGIN WHERE PROVIDER = #{provider}
          AND MEM_NO = (SELECT MEM_NO FROM MEMBERS WHERE MEM_EMAIL = #{email}
          AND USE_YN = 'Y')
    </select>

    <insert id="insertLoginVO" keyProperty="loginNo">
    	<selectKey keyProperty="loginNo" resultType="long" order="BEFORE">
    		SELECT SOCIAL_LOGIN_SEQ.NEXTVAL FROM DUAL
    	</selectKey>
        INSERT INTO SOCIAL_LOGIN (LOGIN_NO, MEM_NO, MEM_PW, PROVIDER, PROV_TOKEN, CREATE_DT, UPDATE_DT, MEM_ID)
        VALUES (#{loginNo}, #{memNo}, #{memPw}, #{provider}, #{provToken}, #{createDt}, #{updateDt}, #{memId})
    </insert>
    
    
    <select id="selectLoginInfo" resultType="com.house.team.user.vo.LoginVO">
    SELECT l.*
    FROM SOCIAL_LOGIN l
    JOIN MEMBERS m ON l.MEM_NO = m.MEM_NO
    WHERE m.MEM_EMAIL = #{email}
      AND m.USE_YN = 'Y'
	</select>
	
	<update id="updatePassword" parameterType="com.house.team.user.vo.LoginVO">
	    UPDATE SOCIAL_LOGIN
	    SET MEM_PW = #{memPw}, UPDATE_DT = SYSDATE
	    WHERE MEM_NO = #{memNo}
	</update>

	<select id="selectLoginInfoByMemNo" resultType="com.house.team.user.vo.LoginVO">
	    SELECT LOGIN_NO, MEM_NO, MEM_PW, PROVIDER, PROV_TOKEN, CREATE_DT, UPDATE_DT, MEM_ID
	    FROM SOCIAL_LOGIN
	    WHERE MEM_NO = #{memNo}
	</select>
	
	<select id="countByMemId" resultType="int">
		SELECT COUNT(*) FROM SOCIAL_LOGIN WHERE MEM_ID = #{memId}
	</select>
	
	<select id="selectLoginByEmail" parameterType="string" resultType="com.house.team.user.vo.LoginVO">
	    SELECT *
	    FROM SOCIAL_LOGIN
	    WHERE PROVIDER = 'local'
	      AND MEM_NO = (
	        SELECT MEM_NO
	        FROM MEMBERS
	        WHERE MEM_EMAIL = #{email}
	          AND USE_YN = 'Y'
	      )
	</select>

<!-- 아이디 로그인 -->
	<select id="selectLoginByUsername" parameterType="string" resultType="com.house.team.user.vo.LoginVO">
	    SELECT *
	    FROM SOCIAL_LOGIN
	    WHERE PROVIDER = 'local'
	      AND MEM_ID = #{username}
	</select>
</mapper>